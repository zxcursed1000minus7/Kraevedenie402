<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .header-content {
            flex: 1;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        
        .mode-toggle, .share-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 14px;
        }
        
        .mode-toggle:hover, .share-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .share-btn {
            background: rgba(52, 152, 219, 0.7);
        }
        
        .share-btn:hover {
            background: rgba(41, 128, 185, 0.7);
        }
        
        .main-content {
            display: flex;
            flex: 1;
            min-height: 0;
            transition: all 0.3s;
        }
        
        /* –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .edit-mode .main-content {
            display: flex;
        }
        
        .edit-mode .control-panel {
            display: block;
            width: 350px;
        }
        
        .edit-mode .map-container {
            flex: 1;
            position: relative;
        }
        
        .edit-mode #map {
            width: 100%;
            height: 100%;
        }
        
        .edit-mode .share-btn {
            display: flex;
        }
        
        /* –†–µ–∂–∏–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ */
        .presentation-mode .main-content {
            display: flex;
        }
        
        .presentation-mode .control-panel {
            display: none;
        }
        
        .presentation-mode .map-container {
            flex: 1;
            width: 100%;
        }
        
        .presentation-mode #map {
            width: 100%;
            height: 100%;
        }
        
        .presentation-mode .mode-toggle {
            background: rgba(255,255,255,0.3);
        }
        
        .presentation-mode .share-btn {
            display: none;
        }
        
        .presentation-mode .info-panel {
            display: flex !important;
        }
        
        /* –†–µ–∂–∏–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ —Å—Å—ã–ª–∫–µ (—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä) */
        .presentation-only .header {
            display: none;
        }
        
        .presentation-only .main-content {
            height: 100%;
            display: flex;
        }
        
        .presentation-only .map-container {
            flex: 1;
            height: 100%;
            width: 100%;
            position: relative;
        }
        
        .presentation-only #map {
            height: 100%;
            width: 100%;
            border-radius: 15px;
        }
        
        .presentation-only .info-panel {
            display: flex !important;
        }
        
        .presentation-only .status-bar {
            display: none;
        }
        
        .map-container {
            flex: 1;
            position: relative;
            min-height: 0;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ—á–∫–µ */
        .info-panel {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 400px;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.1);
            border-left: 1px solid #ddd;
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .info-panel.active {
            display: flex;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        .info-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .info-title {
            font-size: 1.5rem;
            margin: 0;
            padding-right: 40px; /* –ú–µ—Å—Ç–æ –¥–ª—è –∫—Ä–µ—Å—Ç–∏–∫–∞ */
        }
        
        .close-info-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
            z-index: 1001;
        }
        
        .close-info-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        
        .info-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .info-description {
            margin-bottom: 25px;
            line-height: 1.6;
            color: #333;
            font-size: 15px;
        }
        
        .info-gallery {
            margin-bottom: 25px;
        }
        
        .info-gallery-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #333;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .gallery-container {
            position: relative;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .gallery-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 8px;
            display: block;
        }
        
        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }
        
        .gallery-nav:hover {
            background: rgba(0,0,0,0.7);
            transform: translateY(-50%) scale(1.1);
        }
        
        .gallery-prev {
            left: 10px;
        }
        
        .gallery-next {
            right: 10px;
        }
        
        .gallery-counter {
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }
        
        .gallery-thumbnails {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 5px 0;
        }
        
        .gallery-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .gallery-thumb.active {
            opacity: 1;
            border: 2px solid #667eea;
        }
        
        .gallery-thumb:hover {
            opacity: 0.8;
        }
        
        .info-audio {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .info-audio-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #333;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .audio-player {
            width: 100%;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .audio-player audio {
            width: 100%;
        }
        
        /* –£–±—Ä–∞–ª —Ñ—É—Ç–µ—Ä —Å –¥–∞—Ç–æ–π */
        
        .control-panel {
            width: 350px;
            background: #f8f9fa;
            padding: 15px;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        textarea {
            height: 80px;
            resize: vertical;
        }
        
        .file-input-group {
            margin-bottom: 8px;
        }
        
        .file-input-container {
            position: relative;
            margin-bottom: 5px;
        }
        
        .file-input-label {
            display: block;
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input-label:hover {
            background: #e9ecef;
            border-color: #5a67d8;
        }
        
        .file-input-label i {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .file-input-label span {
            display: block;
            font-size: 14px;
            color: #666;
        }
        
        .file-input-label small {
            display: block;
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .file-input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .photos-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .photo-preview-item {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        
        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-photo {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .audio-preview {
            margin-top: 5px;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .audio-preview audio {
            flex: 1;
            height: 30px;
        }
        
        .remove-audio {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .file-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
            flex: 2;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .locations-list {
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        
        .location-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .location-item:hover {
            border-color: #667eea;
            transform: translateX(3px);
        }
        
        .location-item.active {
            border-color: #667eea;
            background: #f0f7ff;
        }
        
        .location-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3px;
        }
        
        .location-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .location-photos-count {
            background: #667eea;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-bar {
            padding: 8px 15px;
            background: #e9ecef;
            text-align: center;
            font-size: 13px;
            color: #666;
            border-top: 1px solid #ddd;
            flex-shrink: 0;
            transition: all 0.3s;
        }
        
        .presentation-mode .status-bar {
            display: none;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å—Å—ã–ª–∫–∏ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 10px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .modal h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.5rem;
        }
        
        .modal p {
            margin-bottom: 20px;
            color: #666;
            line-height: 1.5;
        }
        
        .link-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .link-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: #f8f9fa;
        }
        
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .copy-btn:hover {
            background: #218838;
        }
        
        .copy-btn.copied {
            background: #6c757d;
        }
        
        .qr-code {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .close-modal {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            cursor: pointer;
        }
        
        .close-modal:hover {
            background: #5a6268;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .upload-progress {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10001;
            text-align: center;
        }
        
        .upload-progress.active {
            display: block;
        }
        
        .progress-bar {
            width: 200px;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é" –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ */
        .show-info-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            color: #333;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
            display: none;
        }
        
        .show-info-btn:hover {
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .presentation-only .show-info-btn,
        .presentation-mode .show-info-btn {
            display: block;
        }
        
        .info-hidden .info-panel {
            display: none !important;
        }
        
        .info-hidden .show-info-btn i {
            transform: rotate(180deg);
        }
        
        @media (max-width: 1200px) {
            .info-panel {
                width: 350px;
            }
            
            .gallery-image {
                height: 250px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                height: calc(100vh - 20px);
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .header-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            .mode-toggle, .share-btn {
                flex: 1;
                justify-content: center;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .edit-mode .control-panel {
                width: 100%;
                border-left: none;
                border-top: 1px solid #ddd;
                max-height: 400px;
            }
            
            .edit-mode .map-container {
                min-height: 400px;
            }
            
            .info-panel {
                width: 100%;
                height: 60vh;
                bottom: 0;
                top: auto;
                border-left: none;
                border-top: 1px solid #ddd;
            }
            
            .gallery-image {
                height: 200px;
            }
            
            .show-info-btn {
                top: 5px;
                right: 5px;
                font-size: 12px;
                padding: 6px 12px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .header-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .mode-toggle, .share-btn {
                width: 100%;
            }
            
            .file-input-label {
                padding: 15px;
            }
            
            .photos-preview {
                max-height: 120px;
            }
            
            .photo-preview-item {
                width: 50px;
                height: 50px;
            }
            
            .gallery-image {
                height: 180px;
            }
            
            .info-title {
                font-size: 1.3rem;
            }
            
            .show-info-btn {
                font-size: 11px;
                padding: 5px 10px;
            }
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ Leaflet */
        .leaflet-control-attribution {
            display: none !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∏–∫–æ–Ω–∫–∏ */
        .custom-div-icon {
            background: transparent !important;
            border: none !important;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ */
        .container {
            transition: all 0.3s ease;
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ —Å—Å—ã–ª–∫–µ */
        .back-button {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            color: #333;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .back-button:hover {
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .presentation-only .back-button {
            display: block;
        }
    </style>
</head>
<body>
    <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ —Å—Å—ã–ª–∫–µ -->
    <button class="back-button" id="backButton" style="display: none;">
        <i class="fas fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
    </button>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ -->
    <button class="show-info-btn" id="showInfoBtn">
        <i class="fas fa-chevron-left"></i> –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    </button>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
    <div class="upload-progress" id="uploadProgress">
        <div class="spinner">
            <i class="fas fa-spinner fa-spin fa-2x" style="color: #667eea;"></i>
        </div>
        <div id="uploadText">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div id="uploadCount">0 –∏–∑ 0 —Ñ–∞–π–ª–æ–≤</div>
    </div>
    
    <div class="container edit-mode" id="mainContainer">
        <header>
            <div class="header-content">
                <h1><i class="fas fa-map-marked-alt"></i> –ú–æ—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</h1>
                <p class="subtitle" id="modeSubtitle">–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –¥–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ –º–µ—Å—Ç–∞</p>
            </div>
            <div class="header-buttons">
                <button class="share-btn" id="shareBtn">
                    <i class="fas fa-share-alt"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                </button>
                <button class="mode-toggle" id="modeToggle">
                    <i class="fas fa-tv"></i> –†–µ–∂–∏–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
                </button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
                
                <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ—á–∫–µ -->
                <div class="info-panel" id="infoPanel">
                    <div class="info-header">
                        <div class="info-title" id="infoTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞</div>
                        <button class="close-info-btn" id="closeInfoPanel">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="info-content" id="infoContent">
                        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
            
            <div class="control-panel">
                <div class="form-group">
                    <label for="locationName">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞:</label>
                    <input type="text" id="locationName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
                </div>
                
                <div class="form-group">
                    <label for="latitude">–®–∏—Ä–æ—Ç–∞:</label>
                    <input type="number" id="latitude" step="any" placeholder="55.7558">
                </div>
                
                <div class="form-group">
                    <label for="longitude">–î–æ–ª–≥–æ—Ç–∞:</label>
                    <input type="number" id="longitude" step="any" placeholder="37.6173">
                </div>
                
                <div class="form-group">
                    <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="description" placeholder="–û–ø–∏—à–∏—Ç–µ —ç—Ç–æ –º–µ—Å—Ç–æ"></textarea>
                </div>
                
                <div class="form-group">
                    <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:</label>
                    <div class="file-input-group">
                        <div class="file-input-container">
                            <label class="file-input-label" for="photoUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ</span>
                                <small>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã (JPG, PNG)</small>
                            </label>
                            <input type="file" id="photoUpload" class="file-input" accept="image/*" multiple>
                        </div>
                        <div class="file-info">
                            –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ (–º–∞–∫—Å. 10 —Ñ–∞–π–ª–æ–≤ –ø–æ 5 –ú–ë)
                        </div>
                    </div>
                    <div class="photos-preview" id="photosPreview">
                        <!-- –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>–ê—É–¥–∏–æ—Ñ–∞–π–ª:</label>
                    <div class="file-input-group">
                        <div class="file-input-container">
                            <label class="file-input-label" for="audioUpload" style="padding: 15px;">
                                <i class="fas fa-file-audio"></i>
                                <span>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ</span>
                                <small>MP3, WAV, OGG (–º–∞–∫—Å. 10 –ú–ë)</small>
                            </label>
                            <input type="file" id="audioUpload" class="file-input" accept="audio/*">
                        </div>
                    </div>
                    <div class="audio-preview" id="audioPreview" style="display: none;">
                        <!-- –ü—Ä–µ–≤—å—é –∞—É–¥–∏–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="markerColor">–¶–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞:</label>
                    <select id="markerColor">
                        <option value="#e74c3c">–ö—Ä–∞—Å–Ω—ã–π</option>
                        <option value="#3498db" selected>–°–∏–Ω–∏–π</option>
                        <option value="#2ecc71">–ó–µ–ª–µ–Ω—ã–π</option>
                        <option value="#f39c12">–û—Ä–∞–Ω–∂–µ–≤—ã–π</option>
                        <option value="#9b59b6">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
                        <option value="#1abc9c">–ë–∏—Ä—é–∑–æ–≤—ã–π</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="markerIcon">–ò–∫–æ–Ω–∫–∞ –º–∞—Ä–∫–µ—Ä–∞:</label>
                    <select id="markerIcon">
                        <option value="fa-map-marker-alt" selected>üìç –ú–µ—Ç–∫–∞</option>
                        <option value="fa-landmark">üèõÔ∏è –ü–∞–º—è—Ç–Ω–∏–∫</option>
                        <option value="fa-tree">üå≥ –ü—Ä–∏—Ä–æ–¥–∞</option>
                        <option value="fa-building">üè¢ –ó–¥–∞–Ω–∏–µ</option>
                        <option value="fa-utensils">üçΩÔ∏è –†–µ—Å—Ç–æ—Ä–∞–Ω</option>
                        <option value="fa-bed">üè® –û—Ç–µ–ª—å</option>
                        <option value="fa-museum">üèõÔ∏è –ú—É–∑–µ–π</option>
                        <option value="fa-church">‚õ™ –¶–µ—Ä–∫–æ–≤—å</option>
                        <option value="fa-park">üåø –ü–∞—Ä–∫</option>
                        <option value="fa-camera">üì∑ –§–æ—Ç–æ-—Ç–æ—á–∫–∞</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button class="btn-primary" onclick="addLocation()">
                        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ
                    </button>
                    <button class="btn-secondary" onclick="clearForm()">
                        <i class="fas fa-eraser"></i> –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                </div>
                
                <div class="locations-list" id="locationsList">
                    <h3 style="font-size: 16px; margin-bottom: 10px;">–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ (0)</h3>
                    <!-- –°–ø–∏—Å–æ–∫ –º–µ—Å—Ç –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
        
        <div class="status-bar" id="statusBar">
            –ö–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç.
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å—Å—ã–ª–∫–∏ -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <h2><i class="fas fa-share-alt"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–∞—Ä—Ç–æ–π</h2>
            <p>–°–æ–∑–¥–∞–π—Ç–µ —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç—ã –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏. –≠—Ç—É —Å—Å—ã–ª–∫—É –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–º –ª—é–¥—è–º.</p>
            
            <div class="link-container">
                <input type="text" readonly class="link-input" id="presentationLink">
                <button class="copy-btn" id="copyLinkBtn">
                    <i class="far fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
            
            <div class="qr-code" id="qrCode">
                <!-- QR-–∫–æ–¥ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–¥–µ—Å—å -->
                <p style="color: #666; font-size: 14px;">QR-–∫–æ–¥ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤</p>
                <canvas id="qrCanvas" width="200" height="200"></canvas>
            </div>
            
            <div class="modal-buttons">
                <button class="close-modal" id="closeModal">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è QR-–∫–æ–¥–∞ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/dist/qrcode.min.js"></script>
        <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –±–µ–∑ –∞—Ç—Ä–∏–±—É—Ü–∏–∏
    const map = L.map('map', {
        attributionControl: false,
        zoomControl: true
    }).setView([55.7558, 37.6173], 13);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –∫–∞—Ä—Ç—ã —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–π –∞—Ç—Ä–∏–±—É—Ü–∏–µ–π
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ''
    }).addTo(map);
    
    // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç
    let locations = [];
    let markers = [];
    
    // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –º–µ—Å—Ç–∞
    let photoFiles = [];
    let audioFile = null;
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ä–µ–∂–∏–º–∞ (true = –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è, false = —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
    let isPresentationMode = false;
    
    // ID –∫–∞—Ä—Ç—ã –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
    let mapId = generateMapId();
    
    // –¢–µ–∫—É—â–∞—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –ø–∞–Ω–µ–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    let currentLocation = null;
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
    let infoPanelVisible = true;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ
    const isLocalFile = window.location.protocol === 'file:';
    
    // –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID –∫–∞—Ä—Ç—ã
    function generateMapId() {
        return 'map_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∏–∫–æ–Ω–∫–∏
    function createCustomIcon(color, iconClass) {
        return L.divIcon({
            html: `<div style="
                background: white; 
                border-radius: 50%; 
                padding: 6px; 
                box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
                border: 2px solid ${color};
                display: flex;
                align-items: center;
                justify-content: center;
                width: 34px;
                height: 34px;
            ">
                <i class="fas ${iconClass}" style="color: ${color}; font-size: 16px;"></i>
            </div>`,
            className: 'custom-div-icon',
            iconSize: [34, 34],
            iconAnchor: [17, 34],
            popupAnchor: [0, -34]
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ—á–∫–µ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
    function showLocationInfo(location) {
        currentLocation = location;
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (—Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ)
        document.getElementById('infoTitle').textContent = location.name;
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        const infoContent = document.getElementById('infoContent');
        
        let html = '';
        
        // –û–ø–∏—Å–∞–Ω–∏–µ
        if (location.description) {
            html += `<div class="info-description">${location.description}</div>`;
        }
        
        // –ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ
        if (location.photos && location.photos.length > 0) {
            const galleryId = 'location-gallery-' + location.id;
            html += `
                <div class="info-gallery">
                    <div class="info-gallery-title">
                        <i class="fas fa-images"></i> –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (${location.photos.length})
                    </div>
                    <div class="gallery-container" id="${galleryId}">
                        <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
                        ${location.photos.length > 1 ? `
                            <button class="gallery-nav gallery-prev" onclick="prevGalleryImage('${galleryId}')">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="gallery-nav gallery-next" onclick="nextGalleryImage('${galleryId}')">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        ` : ''}
                        
                        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                        ${location.photos.map((photo, index) => `
                            <img src="${photo}" class="gallery-image" ${index === 0 ? '' : 'style="display:none;"'} data-index="${index}">
                        `).join('')}
                        
                        <!-- –°—á–µ—Ç—á–∏–∫ -->
                        <div class="gallery-counter">–§–æ—Ç–æ 1 –∏–∑ ${location.photos.length}</div>
                        
                        <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã -->
                        ${location.photos.length > 1 ? `
                            <div class="gallery-thumbnails">
                                ${location.photos.map((photo, index) => `
                                    <img src="${photo}" class="gallery-thumb ${index === 0 ? 'active' : ''}" 
                                         onclick="showGalleryImage('${galleryId}', ${index})">
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // –ê—É–¥–∏–æ
        if (location.audioUrl) {
            html += `
                <div class="info-audio">
                    <div class="info-audio-title">
                        <i class="fas fa-volume-up"></i> –ê—É–¥–∏–æ–æ–ø–∏—Å–∞–Ω–∏–µ
                    </div>
                    <div class="audio-player">
                        <audio controls>
                            <source src="${location.audioUrl}" type="audio/mpeg">
                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç.
                        </audio>
                    </div>
                </div>
            `;
        }
        
        infoContent.innerHTML = html;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        document.getElementById('infoPanel').classList.add('active');
        
        // –í —Ä–µ–∂–∏–º–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å, —á—Ç–æ–±—ã –ø–∞–Ω–µ–ª—å –±—ã–ª–∞ –≤–∏–¥–∏–º–∞
        if (isPresentationMode || document.body.classList.contains('presentation-only')) {
            infoPanelVisible = true;
            document.getElementById('showInfoBtn').innerHTML = '<i class="fas fa-chevron-left"></i> –°–∫—Ä—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é';
            document.body.classList.remove('info-hidden');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    function closeInfoPanel() {
        document.getElementById('infoPanel').classList.remove('active');
        
        // –í —Ä–µ–∂–∏–º–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
        if (isPresentationMode || document.body.classList.contains('presentation-only')) {
            infoPanelVisible = false;
            document.getElementById('showInfoBtn').innerHTML = '<i class="fas fa-chevron-right"></i> –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é';
            document.body.classList.add('info-hidden');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏)
    function toggleInfoPanel() {
        if (isPresentationMode || document.body.classList.contains('presentation-only')) {
            infoPanelVisible = !infoPanelVisible;
            
            if (infoPanelVisible) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
                document.getElementById('infoPanel').classList.add('active');
                document.getElementById('showInfoBtn').innerHTML = '<i class="fas fa-chevron-left"></i> –°–∫—Ä—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é';
                document.body.classList.remove('info-hidden');
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
                document.getElementById('infoPanel').classList.remove('active');
                document.getElementById('showInfoBtn').innerHTML = '<i class="fas fa-chevron-right"></i> –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é';
                document.body.classList.add('info-hidden');
            }
        }
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–∞–ª–µ—Ä–µ–µ–π –≤ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    function prevGalleryImage(galleryId) {
        const gallery = document.getElementById(galleryId);
        const images = gallery.querySelectorAll('.gallery-image');
        const thumbs = gallery.querySelectorAll('.gallery-thumb');
        const counter = gallery.querySelector('.gallery-counter');
        
        let currentIndex = 0;
        images.forEach((img, index) => {
            if (img.style.display !== 'none') {
                currentIndex = index;
            }
        });
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        images[currentIndex].style.display = 'none';
        if (thumbs[currentIndex]) {
            thumbs[currentIndex].classList.remove('active');
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ
        const newIndex = (currentIndex - 1 + images.length) % images.length;
        images[newIndex].style.display = 'block';
        if (thumbs[newIndex]) {
            thumbs[newIndex].classList.add('active');
        }
        
        counter.textContent = `–§–æ—Ç–æ ${newIndex + 1} –∏–∑ ${images.length}`;
    }
    
    function nextGalleryImage(galleryId) {
        const gallery = document.getElementById(galleryId);
        const images = gallery.querySelectorAll('.gallery-image');
        const thumbs = gallery.querySelectorAll('.gallery-thumb');
        const counter = gallery.querySelector('.gallery-counter');
        
        let currentIndex = 0;
        images.forEach((img, index) => {
            if (img.style.display !== 'none') {
                currentIndex = index;
            }
        });
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        images[currentIndex].style.display = 'none';
        if (thumbs[currentIndex]) {
            thumbs[currentIndex].classList.remove('active');
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ
        const newIndex = (currentIndex + 1) % images.length;
        images[newIndex].style.display = 'block';
        if (thumbs[newIndex]) {
            thumbs[newIndex].classList.add('active');
        }
        
        counter.textContent = `–§–æ—Ç–æ ${newIndex + 1} –∏–∑ ${images.length}`;
    }
    
    function showGalleryImage(galleryId, index) {
        const gallery = document.getElementById(galleryId);
        const images = gallery.querySelectorAll('.gallery-image');
        const thumbs = gallery.querySelectorAll('.gallery-thumb');
        const counter = gallery.querySelector('.gallery-counter');
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        images.forEach(img => img.style.display = 'none');
        thumbs.forEach(thumb => thumb.classList.remove('active'));
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
        images[index].style.display = 'block';
        thumbs[index].classList.add('active');
        
        counter.textContent = `–§–æ—Ç–æ ${index + 1} –∏–∑ ${images.length}`;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
    function toggleMode() {
        const container = document.getElementById('mainContainer');
        const modeToggle = document.getElementById('modeToggle');
        const modeSubtitle = document.getElementById('modeSubtitle');
        const backButton = document.getElementById('backButton');
        const showInfoBtn = document.getElementById('showInfoBtn');
        
        isPresentationMode = !isPresentationMode;
        
        if (isPresentationMode) {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
            container.classList.remove('edit-mode');
            container.classList.add('presentation-mode');
            modeToggle.innerHTML = '<i class="fas fa-edit"></i> –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
            modeSubtitle.textContent = '–†–µ–∂–∏–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏: –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫—Ä—ã—Ç–∞';
            backButton.style.display = 'block';
            showInfoBtn.style.display = 'block';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞)
            if (currentLocation) {
                showLocationInfo(currentLocation);
            } else if (locations.length > 0) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Ç–æ—á–∫—É
                showLocationInfo(locations[0]);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã
            setTimeout(() => {
                map.invalidateSize();
            }, 300);
            
            console.log('üñ•Ô∏è –†–µ–∂–∏–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –≤–∫–ª—é—á–µ–Ω');
        } else {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            container.classList.remove('presentation-mode');
            container.classList.add('edit-mode');
            modeToggle.innerHTML = '<i class="fas fa-tv"></i> –†–µ–∂–∏–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏';
            modeSubtitle.textContent = '–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –¥–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ –º–µ—Å—Ç–∞';
            backButton.style.display = 'none';
            showInfoBtn.style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã
            setTimeout(() => {
                map.invalidateSize();
            }, 300);
            
            console.log('‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
    function generatePresentationLink() {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –≤ localStorage
        saveMapData();
        
        // –ï—Å–ª–∏ —Ñ–∞–π–ª –∑–∞–ø—É—â–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ, —Å–æ–∑–¥–∞–µ–º –æ—Å–æ–±—É—é —Å—Å—ã–ª–∫—É
        if (isLocalFile) {
            // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
            const fileName = window.location.pathname.split('/').pop() || '–∫–∞—Ä—Ç–∞.html';
            return `–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª ${fileName}?mode=presentation&id=${mapId} –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ`;
        }
        
        // –î–ª—è –≤–µ–±-–≤–µ—Ä—Å–∏–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—É—é —Å—Å—ã–ª–∫—É
        let baseUrl = window.location.origin + window.location.pathname;
        
        // –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥—É–±–ª–∏—Ä—É—é—â–∏–µ —Å–ª–µ—à–∏
        baseUrl = baseUrl.replace(/([^:]\/)\/+/g, "$1");
        
        // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        baseUrl = baseUrl.split('?')[0];
        baseUrl = baseUrl.split('#')[0];
        
        const presentationUrl = `${baseUrl}?mode=presentation&id=${mapId}`;
        
        return presentationUrl;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å —Å—Å—ã–ª–∫–æ–π
    function openShareModal() {
        try {
            const presentationLink = generatePresentationLink();
            const linkInput = document.getElementById('presentationLink');
            if (!linkInput) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç presentationLink –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            linkInput.value = presentationLink;
            
            // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –≤–º–µ—Å—Ç–æ QR-–∫–æ–¥–∞
            if (isLocalFile) {
                document.getElementById('qrCode').innerHTML = `
                    <p style="color:#e74c3c; font-weight:bold;">‚ö†Ô∏è –§–∞–π–ª –∑–∞–ø—É—â–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ</p>
                    <p style="color:#666; font-size:14px; margin:10px 0;">
                        –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∂–∏–º–∞ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏:
                    </p>
                    <ol style="text-align:left; font-size:13px; color:#666; padding-left:20px;">
                        <li>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç HTML-—Ñ–∞–π–ª</li>
                        <li>–û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:<br>
                            <code style="background:#f1f1f1; padding:2px 5px;">?mode=presentation&id=${mapId}</code>
                        </li>
                        <li>–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, Live Server –≤ VS Code)</li>
                    </ol>
                `;
            } else {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ–±-–≤–µ—Ä—Å–∏–∏
                try {
                    generateQRCode(presentationLink);
                } catch (qrError) {
                    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞:', qrError);
                    document.getElementById('qrCode').innerHTML = 
                        '<p style="color:#e74c3c;">QR-–∫–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>';
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const shareModal = document.getElementById('shareModal');
            if (shareModal) {
                shareModal.classList.add('active');
            } else {
                console.error('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ shareModal –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –≤ openShareModal:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –æ–∫–Ω–∞');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏
    function copyLinkToClipboard() {
        const linkInput = document.getElementById('presentationLink');
        if (!linkInput) {
            console.error('–≠–ª–µ–º–µ–Ω—Ç presentationLink –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        linkInput.select();
        linkInput.setSelectionRange(0, 99999);
        
        navigator.clipboard.writeText(linkInput.value)
            .then(() => {
                const copyBtn = document.getElementById('copyLinkBtn');
                if (copyBtn) {
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    copyBtn.classList.add('copied');
                    
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                        copyBtn.classList.remove('copied');
                    }, 2000);
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
                // –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                try {
                    document.execCommand('copy');
                    const copyBtn = document.getElementById('copyLinkBtn');
                    if (copyBtn) {
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                        copyBtn.classList.add('copied');
                        
                        setTimeout(() => {
                            copyBtn.innerHTML = originalText;
                            copyBtn.classList.remove('copied');
                        }, 2000);
                    }
                } catch (e) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: ' + linkInput.value);
                }
            });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞
    function generateQRCode(url) {
        const canvas = document.getElementById('qrCanvas');
        if (!canvas) {
            console.error('Canvas –¥–ª—è QR-–∫–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        
        // –û—á–∏—â–∞–µ–º canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ QRCode
        if (typeof QRCode === 'undefined') {
            console.error('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ QRCode –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            document.getElementById('qrCode').innerHTML = 
                '<p style="color:#e74c3c;">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ QR-–∫–æ–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>';
            return;
        }
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥
        try {
            QRCode.toCanvas(canvas, url, {
                width: 200,
                margin: 1,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (error) {
                    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞:', error);
                    document.getElementById('qrCode').innerHTML = 
                        '<p style="color:#e74c3c;">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥</p>';
                }
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞:', error);
            document.getElementById('qrCode').innerHTML = 
                '<p style="color:#e74c3c;">–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞</p>';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –≤ base64
    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                resolve({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: e.target.result
                });
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    function showUploadProgress(total, current) {
        const progress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const uploadCount = document.getElementById('uploadCount');
        const uploadText = document.getElementById('uploadText');
        
        if (!progress) return;
        
        progress.classList.add('active');
        if (progressFill) {
            progressFill.style.width = `${(current / total) * 100}%`;
        }
        if (uploadCount) {
            uploadCount.textContent = `${current} –∏–∑ ${total} —Ñ–∞–π–ª–æ–≤`;
        }
        if (uploadText && current === total) {
            uploadText.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤...';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    function hideUploadProgress() {
        const progress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        
        if (!progress) return;
        
        setTimeout(() => {
            progress.classList.remove('active');
            if (progressFill) {
                progressFill.style.width = '0%';
            }
            const uploadText = document.getElementById('uploadText');
            if (uploadText) {
                uploadText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...';
            }
        }, 500);
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
    const photoUpload = document.getElementById('photoUpload');
    if (photoUpload) {
        photoUpload.addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ñ–∞–π–ª–æ–≤
            if (files.length > 10) {
                alert('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ 10 —Ñ–æ—Ç–æ –∑–∞ —Ä–∞–∑');
                this.value = '';
                return;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ —Ä–∞–∑–º–µ—Ä—É —Ñ–∞–π–ª–∞ (5 –ú–ë)
            const oversizedFiles = files.filter(file => file.size > 5 * 1024 * 1024);
            if (oversizedFiles.length > 0) {
                alert('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ (–º–∞–∫—Å–∏–º—É–º 5 –ú–ë)');
                this.value = '';
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            showUploadProgress(files.length, 0);
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    showUploadProgress(files.length, i + 1);
                    
                    // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ base64
                    const fileData = await readFileAsBase64(file);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
                    photoFiles.push(fileData);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                    updatePhotosPreview();
                }
                
                updateStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${files.length} —Ñ–æ—Ç–æ. –í—Å–µ–≥–æ: ${photoFiles.length}`);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ');
            } finally {
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                hideUploadProgress();
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                this.value = '';
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ
    const audioUpload = document.getElementById('audioUpload');
    if (audioUpload) {
        audioUpload.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            
            if (!file) return;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            if (!file.type.startsWith('audio/')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª');
                this.value = '';
                return;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ —Ä–∞–∑–º–µ—Ä—É (10 –ú–ë)
            if (file.size > 10 * 1024 * 1024) {
                alert('–ê—É–¥–∏–æ—Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 10 –ú–ë)');
                this.value = '';
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            showUploadProgress(1, 0);
            
            try {
                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ base64
                audioFile = await readFileAsBase64(file);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                updateAudioPreview();
                
                updateStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∞—É–¥–∏–æ: ${file.name}`);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞');
            } finally {
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                hideUploadProgress();
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                this.value = '';
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ
    function updatePhotosPreview() {
        const previewContainer = document.getElementById('photosPreview');
        if (!previewContainer) return;
        
        previewContainer.innerHTML = '';
        
        photoFiles.forEach((fileData, index) => {
            const item = document.createElement('div');
            item.className = 'photo-preview-item';
            item.innerHTML = `
                <img src="${fileData.data}" alt="${fileData.name}">
                <button type="button" class="remove-photo" onclick="removePhoto(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            previewContainer.appendChild(item);
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–≤—å—é –∞—É–¥–∏–æ
    function updateAudioPreview() {
        const previewContainer = document.getElementById('audioPreview');
        if (!previewContainer) return;
        
        if (audioFile) {
            previewContainer.innerHTML = `
                <audio controls>
                    <source src="${audioFile.data}" type="${audioFile.type}">
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç.
                </audio>
                <button type="button" class="remove-audio" onclick="removeAudio()">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            previewContainer.style.display = 'flex';
        } else {
            previewContainer.style.display = 'none';
        }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –∏–∑ –ø—Ä–µ–≤—å—é
    function removePhoto(index) {
        photoFiles.splice(index, 1);
        updatePhotosPreview();
        updateStatus(`–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ. –û—Å—Ç–∞–ª–æ—Å—å: ${photoFiles.length}`);
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –∞—É–¥–∏–æ –∏–∑ –ø—Ä–µ–≤—å—é
    function removeAudio() {
        audioFile = null;
        updateAudioPreview();
        updateStatus('–ê—É–¥–∏–æ—Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω');
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã –≤ localStorage
    function saveMapData() {
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const mapData = {
            id: mapId,
            locations: locations.map(location => ({
                ...location,
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ base64
                photos: location.photos,
                audioUrl: location.audioUrl
            })),
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        try {
            localStorage.setItem('interactive_map_' + mapId, JSON.stringify(mapData));
            console.log('üíæ –ö–∞—Ä—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:', mapId, '–ú–µ—Å—Ç:', locations.length);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', error);
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã –∏–∑ localStorage
    function loadMapData(id) {
        try {
            const data = localStorage.getItem('interactive_map_' + id);
            if (data) {
                const mapData = JSON.parse(data);
                locations = mapData.locations || [];
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ
                restoreMarkers();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–µ—Å—Ç
                updateLocationsList();
                
                console.log('üìÇ –ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', id, '–ú–µ—Å—Ç:', locations.length);
                return true;
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã:', e);
        }
        return false;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    function restoreMarkers() {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        locations.forEach(location => {
            const marker = L.marker([location.lat, location.lng], {
                icon: createCustomIcon(location.color, location.icon)
            }).addTo(map);
            
            // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
            marker.on('click', function() {
                showLocationInfo(location);
                
                // –í—ã–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ –≤ —Å–ø–∏—Å–∫–µ
                highlightLocationInList(location.id);
                
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç—É –∫ —Ç–æ—á–∫–µ
                map.flyTo([location.lat, location.lng], 16);
            });
            
            marker.locationId = location.id;
            markers.push(marker);
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ
    function highlightLocationInList(locationId) {
        // –£–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        document.querySelectorAll('.location-item').forEach(el => {
            el.classList.remove('active');
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
        const locationItem = document.querySelector(`.location-item[data-id="${locationId}"]`);
        if (locationItem) {
            locationItem.classList.add('active');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–∞
    function addLocation() {
        const name = document.getElementById('locationName')?.value.trim();
        const lat = parseFloat(document.getElementById('latitude')?.value);
        const lng = parseFloat(document.getElementById('longitude')?.value);
        const description = document.getElementById('description')?.value.trim();
        const color = document.getElementById('markerColor')?.value;
        const icon = document.getElementById('markerIcon')?.value;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∞
        if (!name) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞');
            return;
        }
        
        if (isNaN(lat) || isNaN(lng)) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã');
            return;
        }
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ç–æ
        const photos = photoFiles.length > 0 
            ? photoFiles.map(file => file.data) 
            : ['https://images.unsplash.com/photo-1513326738677-b964603b136d?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'];
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∞—É–¥–∏–æ
        const audioData = audioFile ? audioFile.data : '';
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
        const id = Date.now();
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –º–µ—Å—Ç–∞
        const location = {
            id: id,
            name: name,
            lat: lat,
            lng: lng,
            description: description,
            photos: photos,
            audioUrl: audioData,
            color: color,
            icon: icon
        };
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –º–∞—Å—Å–∏–≤
        locations.push(location);
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç—É
        const marker = L.marker([lat, lng], {
            icon: createCustomIcon(color, icon)
        }).addTo(map);
        
        // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
        marker.on('click', function() {
            showLocationInfo(location);
            
            // –í—ã–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ –≤ —Å–ø–∏—Å–∫–µ
            highlightLocationInList(location.id);
            
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç—É –∫ —Ç–æ—á–∫–µ
            map.flyTo([lat, lng], 16);
        });
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
        marker.locationId = id;
        markers.push(marker);
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
        updateLocationsList();
        
        // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        clearForm();
        
        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–π —Ç–æ—á–∫–µ
        map.flyTo([lat, lng], 15);
        
        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        saveMapData();
        
        updateStatus(`–î–æ–±–∞–≤–ª–µ–Ω–æ: "${name}" —Å ${photos.length} —Ñ–æ—Ç–æ${audioData ? ' –∏ –∞—É–¥–∏–æ' : ''}`);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –º–µ—Å—Ç
    function updateLocationsList() {
        const container = document.getElementById('locationsList');
        if (!container) return;
        
        const header = container.querySelector('h3') || document.createElement('h3');
        header.innerHTML = `–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ (${locations.length})`;
        if (!container.querySelector('h3')) {
            container.prepend(header);
        }
        
        // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç—ã –º–µ—Å—Ç, –æ—Å—Ç–∞–≤–ª—è—è –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const existingItems = container.querySelectorAll('.location-item');
        existingItems.forEach(item => item.remove());
        
        locations.slice().reverse().forEach((location) => {
            const item = document.createElement('div');
            item.className = 'location-item';
            item.setAttribute('data-id', location.id);
            item.innerHTML = `
                <div class="location-item-header">
                    <div class="location-title">
                        <i class="fas ${location.icon}" style="color:${location.color};"></i>
                        ${location.name}
                    </div>
                    <div class="location-photos-count">
                        ${location.photos.length} —Ñ–æ—Ç–æ${location.audioUrl ? ' + –∞—É–¥–∏–æ' : ''}
                    </div>
                </div>
            `;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞
            item.addEventListener('click', function() {
                // –£–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                document.querySelectorAll('.location-item').forEach(el => {
                    el.classList.remove('active');
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
                this.classList.add('active');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ—á–∫–µ
                showLocationInfo(location);
                
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç—É –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –º–µ—Å—Ç—É
                map.flyTo([location.lat, location.lng], 16);
            });
            
            container.appendChild(item);
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Ñ–æ—Ä–º—ã
    function clearForm() {
        const locationName = document.getElementById('locationName');
        const description = document.getElementById('description');
        
        if (locationName) locationName.value = '';
        if (description) description.value = '';
        
        photoFiles = [];
        audioFile = null;
        updatePhotosPreview();
        updateAudioPreview();
        
        if (locationName) locationName.focus();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    function updateStatus(message) {
        const statusBar = document.getElementById('statusBar');
        if (statusBar) {
            statusBar.textContent = message;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    function checkUrlParams() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const id = urlParams.get('id');
            
            if (mode === 'presentation' && id) {
                // –†–µ–∂–∏–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ —Å—Å—ã–ª–∫–µ
                if (loadMapData(id)) {
                    mapId = id;
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                    document.body.classList.add('presentation-only');
                    const mainContainer = document.getElementById('mainContainer');
                    if (mainContainer) {
                        mainContainer.classList.add('presentation-mode');
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
                    const backButton = document.getElementById('backButton');
                    if (backButton) {
                        backButton.style.display = 'block';
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                    const showInfoBtn = document.getElementById('showInfoBtn');
                    if (showInfoBtn) {
                        showInfoBtn.style.display = 'block';
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Ç–æ—á–∫—É
                    if (locations.length > 0) {
                        showLocationInfo(locations[0]);
                        map.setView([locations[0].lat, locations[0].lng], 13);
                    }
                    
                    console.log('üîó –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∫–∞—Ä—Ç–∞ –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏:', id);
                } else {
                    alert('–ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í–æ–∑–º–æ–∂–Ω–æ, —Å—Å—ã–ª–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞.');
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                    window.location.href = window.location.pathname;
                }
            } else if (mode === 'presentation' && !id) {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
                mapId = generateMapId();
                saveMapData();
                
                const newUrl = window.location.origin + window.location.pathname + 
                              '?mode=presentation&id=' + mapId;
                window.location.href = newUrl;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –≤ checkUrlParams:', error);
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é" –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ —Å—Å—ã–ª–∫–µ
    function goToEditMode() {
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const editUrl = window.location.origin + window.location.pathname + 
                      '?id=' + mapId;
        window.location.href = editUrl;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç—É
    map.on('click', function(e) {
        if (!isPresentationMode && !document.body.classList.contains('presentation-only')) {
            const latitude = document.getElementById('latitude');
            const longitude = document.getElementById('longitude');
            
            if (latitude) latitude.value = e.latlng.lat.toFixed(6);
            if (longitude) longitude.value = e.latlng.lng.toFixed(6);
            
            updateStatus(`–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`);
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    function init() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
        checkUrlParams();
        
        // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å—Å—ã–ª–∫–µ)
        if (!document.body.classList.contains('presentation-only')) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            
            if (id) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç—É
                if (loadMapData(id)) {
                    mapId = id;
                    updateStatus(`–ö–∞—Ä—Ç–∞ "${mapId}" –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –î–æ–±–∞–≤–ª–µ–Ω–æ ${locations.length} –º–µ—Å—Ç.`);
                }
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É
                saveMapData();
            }
            
            // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è
            const locationName = document.getElementById('locationName');
            if (locationName) {
                locationName.focus();
            }
            
            updateStatus('–ö–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.');
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –∫—Ä–µ—Å—Ç–∏–∫—É (–≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å)
        const closeInfoPanelBtn = document.getElementById('closeInfoPanel');
        if (closeInfoPanelBtn) {
            closeInfoPanelBtn.addEventListener('click', closeInfoPanel);
        }
        
        // –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
        const showInfoBtn = document.getElementById('showInfoBtn');
        if (showInfoBtn) {
            showInfoBtn.addEventListener('click', toggleInfoPanel);
        }
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ (–µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å)
        const modeToggle = document.getElementById('modeToggle');
        if (modeToggle) {
            modeToggle.addEventListener('click', toggleMode);
        }
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" (–µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å)
        const shareBtn = document.getElementById('shareBtn');
        if (shareBtn) {
            shareBtn.addEventListener('click', openShareModal);
        }
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        if (copyLinkBtn) {
            copyLinkBtn.addEventListener('click', copyLinkToClipboard);
        }
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const closeModalBtn = document.getElementById('closeModal');
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', function() {
                const shareModal = document.getElementById('shareModal');
                if (shareModal) {
                    shareModal.classList.remove('active');
                }
            });
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
        const shareModal = document.getElementById('shareModal');
        if (shareModal) {
            shareModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        }
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
        const backButton = document.getElementById('backButton');
        if (backButton) {
            backButton.addEventListener('click', goToEditMode);
        }
        
        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', function(e) {
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ø–æ Alt+P
            if (e.altKey && e.key === 'p') {
                if (modeToggle) {
                    toggleMode();
                }
                e.preventDefault();
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ ESC
            if (e.key === 'Escape') {
                closeInfoPanel();
                const shareModal = document.getElementById('shareModal');
                if (shareModal) {
                    shareModal.classList.remove('active');
                }
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
            if ((isPresentationMode || document.body.classList.contains('presentation-only')) && e.key === 'i') {
                toggleInfoPanel();
                e.preventDefault();
            }
        });
        
        // Drag and drop –¥–ª—è —Ñ–æ—Ç–æ (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        const photoDropZone = document.getElementById('photoUpload');
        if (photoDropZone) {
            const photoDropZoneParent = photoDropZone.parentElement;
            photoDropZoneParent.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.background = '#e9ecef';
                this.style.borderColor = '#5a67d8';
            });
            
            photoDropZoneParent.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.background = '';
                this.style.borderColor = '';
            });
            
            photoDropZoneParent.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.background = '';
                this.style.borderColor = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    // –°–æ–∑–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ change –¥–ª—è input
                    const input = document.getElementById('photoUpload');
                    input.files = files;
                    input.dispatchEvent(new Event('change'));
                }
            });
        }
        
        // Drag and drop –¥–ª—è –∞—É–¥–∏–æ (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        const audioDropZone = document.getElementById('audioUpload');
        if (audioDropZone) {
            const audioDropZoneParent = audioDropZone.parentElement;
            audioDropZoneParent.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.background = '#e9ecef';
                this.style.borderColor = '#5a67d8';
            });
            
            audioDropZoneParent.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.background = '';
                this.style.borderColor = '';
            });
            
            audioDropZoneParent.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.background = '';
                this.style.borderColor = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª –¥–ª—è –∞—É–¥–∏–æ
                    const input = document.getElementById('audioUpload');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(files[0]);
                    input.files = dataTransfer.files;
                    input.dispatchEvent(new Event('change'));
                }
            });
        }
    }
    
    // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    init();
    
    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª–∏
    window.addLocation = addLocation;
    window.clearForm = clearForm;
    window.locations = locations;
    window.markers = markers;
    window.prevGalleryImage = prevGalleryImage;
    window.nextGalleryImage = nextGalleryImage;
    window.showGalleryImage = showGalleryImage;
    window.toggleMode = toggleMode;
    window.toggleInfoPanel = toggleInfoPanel;
    window.closeInfoPanel = closeInfoPanel;
    window.generatePresentationLink = generatePresentationLink;
    window.saveMapData = saveMapData;
    window.loadMapData = loadMapData;
    
    console.log('‚úÖ –ö–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞!');
    console.log('üåê –†–µ–∂–∏–º:', isLocalFile ? '–õ–æ–∫–∞–ª—å–Ω—ã–π (file://)' : '–í–µ–±-—Å–µ—Ä–≤–µ—Ä (http/https)');
    console.log('üîó ID –∫–∞—Ä—Ç—ã:', mapId);
</script>
</body>
</html>